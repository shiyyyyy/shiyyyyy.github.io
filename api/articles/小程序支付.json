{"title":"小程序支付-前端代码","slug":"小程序支付","date":"2018-03-25T11:32:08.000Z","updated":"2018-03-25T11:51:44.000Z","comments":true,"path":"api/articles/小程序支付.json","photos":[],"link":"","excerpt":null,"covers":null,"content":"<p>这里只有前端的代码，其实大部分支付流程都是后端写的，因为安全原因，很多东西是不放在前端的，所以前端的代码其实很简单。</p>\n<p>首先，要获取用户的openId，在这里为sid</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;!-- app.js --&gt;</span><br><span class=\"line\">onLaunch: <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// 展示本地存储能力</span></span><br><span class=\"line\">    <span class=\"keyword\">var</span> logs = wx.getStorageSync(<span class=\"string\">'logs'</span>) || []</span><br><span class=\"line\">    logs.unshift(<span class=\"built_in\">Date</span>.now())</span><br><span class=\"line\">    wx.setStorageSync(<span class=\"string\">'logs'</span>, logs)</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.sid = wx.getStorageSync(<span class=\"string\">'sid'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 登录</span></span><br><span class=\"line\">    wx.login(&#123;</span><br><span class=\"line\">      success: <span class=\"function\"><span class=\"params\">res</span> =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 发送 res.code 到后台换取 openId, sessionKey, unionId</span></span><br><span class=\"line\">        <span class=\"keyword\">this</span>.post(</span><br><span class=\"line\">          <span class=\"string\">'api/WxPay/login'</span>,</span><br><span class=\"line\">          &#123; <span class=\"attr\">code</span>: res.code &#125;,</span><br><span class=\"line\">          data =&gt; &#123;</span><br><span class=\"line\">            wx.setStorageSync(<span class=\"string\">'sid'</span>, data.sid)</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.sid = data.sid</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        )</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>然后，需要写出请求的request函数。<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">host: <span class=\"string\">'https://xxx.xxx.cpm/xxxxxx/'</span>,</span><br><span class=\"line\">post: <span class=\"function\">(<span class=\"params\">url, data, cb</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    data = data || &#123;&#125;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> app = getApp();</span><br><span class=\"line\">    data.sid = app.sid;</span><br><span class=\"line\">    url = app.host + url;</span><br><span class=\"line\">    wx.request(&#123;</span><br><span class=\"line\">      url: url,</span><br><span class=\"line\">      data: data,</span><br><span class=\"line\">      method: <span class=\"string\">'POST'</span>,</span><br><span class=\"line\">      success: <span class=\"function\"><span class=\"params\">res</span> =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> data = res.data;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!data.success) &#123;</span><br><span class=\"line\">          wx.showModal(&#123;</span><br><span class=\"line\">            title: <span class=\"string\">'出错了'</span>,</span><br><span class=\"line\">            content: data.message,</span><br><span class=\"line\">          &#125;)</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">          cb(data.data)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      fail: <span class=\"function\"><span class=\"params\">res</span> =&gt;</span> &#123;</span><br><span class=\"line\">        wx.showModal(&#123;</span><br><span class=\"line\">          title: <span class=\"string\">'请求失败'</span>,</span><br><span class=\"line\">          content: <span class=\"built_in\">JSON</span>.stringify(res),</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>最后，支付的事件。<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;!-- 支付事件触发 --&gt;</span><br><span class=\"line\">pay: <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">e</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// order_id为订单唯一id 根据订单id支付金额</span></span><br><span class=\"line\">    getApp().post(<span class=\"string\">'xx/xxx/xxx'</span>, &#123; <span class=\"attr\">order_id</span>: roder_id &#125;, data =&gt; &#123;</span><br><span class=\"line\">      wx.requestPayment(&#123;</span><br><span class=\"line\">        <span class=\"string\">'timeStamp'</span>: data.timeStamp,</span><br><span class=\"line\">        <span class=\"string\">'nonceStr'</span>: data.nonceStr,</span><br><span class=\"line\">        <span class=\"string\">'package'</span>: data.package,</span><br><span class=\"line\">        <span class=\"string\">'signType'</span>: <span class=\"string\">'MD5'</span>,</span><br><span class=\"line\">        <span class=\"string\">'paySign'</span>: data.paySign,</span><br><span class=\"line\">        <span class=\"string\">'success'</span>: <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">res</span>) </span>&#123;</span><br><span class=\"line\">          wx.showToast(&#123;</span><br><span class=\"line\">            title: <span class=\"string\">'支付成功'</span>,</span><br><span class=\"line\">          &#125;)</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">'fail'</span>: <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">res</span>) </span>&#123;</span><br><span class=\"line\">          wx.showModal(&#123;</span><br><span class=\"line\">            title: <span class=\"string\">'支付失败'</span></span><br><span class=\"line\">          &#125;)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>其实前端的代码真的不多，很多数据都是在后端处理的，放在前端的安全性不够。<br>前端代码就到这里，改天再放后端代码，哈哈</p>\n","categories":[],"tags":[]}